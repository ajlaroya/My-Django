{% extends "posts/post_base.html" %}

{% load static %}

{% load bulma_tags %}

{% block title %}<title>Plume - Detail</title>{% endblock %}

{% block post_content %}
<h1 class="title has-text-light">Post detail
  {% if request.user == post.author %}
  <a href="{% url 'posts:edit' post.pk %}"><span class="material-icons">edit</span></a>
  <a href="{% url 'posts:delete' post.pk %}"><span class="material-icons">delete</span></a>
  {% endif %}
</h1>

<a href="{% url 'posts:all' %}" class="has-text-warning">Return to Feed</a>

<div class="row mt-3 column is-three-quarters">
  <!-- Post in detail -->
  {% include "posts/_post.html" %}

  <div class="pl-5">
    <!-- Comments -->
    {% for comment in comments %}
    {% if comment.is_parent %}
    <article class="media">
      <figure class="media-left">
        <a href="{% url 'accounts:profile' comment.author.profile.pk %}">
          <img class="image" height="40" width="40" src="{{ comment.author.profile.picture.url }}" />
        </a>
      </figure>
      <div class="media-content">
        <div class="content">
          <span class="post-text">
            <a class="text-primary post-link" href="{% url 'accounts:profile' comment.author.profile.pk %}">@{{ comment.author }}</a> {{ comment.timestamp }}
          </span>
          <p>{{ comment.comment }}</p>
        </div>
        <nav class="level is-mobile">
          <div class="level-left">
            <a class="level-item has-text-warning has-tooltip-bottom has-tooltip-arrow has-tooltip-warning" data-tooltip="Reply">
              <span class="material-icons" onclick="commentReplyToggle('{{ comment.pk }}')">reply</span>
            </a>
            <form class="level-item" method="POST" action="{% url 'posts:comment-like' post.pk comment.pk%}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <button style="background-color: transparent; border: none; box-shadow: none;" type="submit">
                {% if user in comment.likes.all %}
                <a class="level-item has-text-warning">
                  <span class="material-icons">favorite</span>
                </a>
                {% else %}
                <a class="level-item has-text-warning">
                  <span class="material-icons">favorite_border</span>
                </a>
                {% endif %}
              </button>
              <span class="level-item">{{ comment.likes.all.count }}</span>
            </form>
          </nav>
          <div class="mt-3 mb-5 is-hidden" id="{{ comment.pk }}">
            <div class="col">
              <form method="POST" action="{% url 'posts:comment-reply' post.pk comment.pk %}">
                {% csrf_token %}
                {{ form | bulma }}
                <div class="d-grid gap-2">
                  <button class="button mt-3">Reply!</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="media-right">
          {% if request.user == comment.author %}
          <a href="{% url 'posts:comment-delete' post.pk comment.pk %}">Delete comment</a>
          {% endif %}
        </div>
      </article>

      <!-- Comment replies -->
      <div class="pl-5 mb-5">
        {% for child_comment in comment.children %}
        <article class="media">
          <figure class="media-left">
            <a href="{% url 'accounts:profile' child_comment.author.profile.pk %}">
              <img class="image" height="40" width="40" src="{{ child_comment.author.profile.picture.url }}" />
            </a>
          </figure>
          <div class="media-content">
            <div class="content">
              <span class="post-text">
                <a class="text-primary post-link" href="{% url 'accounts:profile' child_comment.author.profile.pk %}">@{{ child_comment.author }}</a> {{ child_comment.timestamp }}
              </span>
              <p>{{ child_comment.comment }}</p>
            </div>
            <nav class="level is-mobile">
              <div class="level-left">
                <form class="level-item" method="POST" action="{% url 'posts:comment-like' post.pk child_comment.pk%}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.path }}">
                  <button style="background-color: transparent; border: none; box-shadow: none;" type="submit">
                    {% if user in child_comment.likes.all %}
                    <a class="level-item has-text-warning">
                      <span class="material-icons">favorite</span>
                    </a>
                    {% else %}
                    <a class="level-item has-text-warning">
                      <span class="material-icons">favorite_border</span>
                    </a>
                    {% endif %}
                  </button>
                  <span class="level-item">{{ child_comment.likes.all.count }}</span>
                </form>
              </nav>
            </div>
            <div class="media-right">
              {% if request.user == child_comment.author %}
              <a href="{% url 'posts:comment-delete' post.pk child_comment.pk %}">Delete comment</a>
              {% endif %}
            </div>
          </article>
          {% endfor %}
        </div>

        {% endif %}
        {% endfor %}

        <form class="mt-5" method="POST">
          {% csrf_token %}
          {{ form | bulma }}
          <button class="button mt-3">Comment</button>
        </form>

      </div>

    </div>
{% endblock %}
