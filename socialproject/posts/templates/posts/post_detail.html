{% extends "posts/post_base.html" %}

{% load static %}

{% load bulma_tags %}

{% block title %}<title>Plume - @{{ post.author }}'s post</title>{% endblock %}

{% block post_content %}
<h1 class="title has-text-light">@{{ post.author }}'s post
  {% if request.user == post.author %}
  <a href="{% url 'posts:edit' post.pk %}"><i class="material-icons has-text-warning">edit</i></a>
  <a href="{% url 'posts:delete' post.pk %}"><i class="material-icons has-text-warning">delete</i></a>
  {% endif %}
</h1>

<a href="{{request.META.HTTP_REFERER|escape}}"><input type="submit" class="button mb-5" value="Go back"></a>

<div class="row mt-3 column is-three-quarters">

  <!-- Singular post -->
  {% include "posts/_post.html" %}

  <!-- Comments -->
  <div class="pl-5">

    <!-- Parent comment -->
    {% for comment in comments %}
      {% if comment.is_parent %}
      <article class="media">
        <figure class="media-left">
          <a href="{% url 'accounts:profile' comment.author.profile.pk %}">
            <img class="image" height="40" width="40" src="{{ comment.author.profile.picture.url }}" />
          </a>
        </figure>
        <div class="media-content">
          <div class="content">
            <p>
              <strong>
                <a class="has-text-warning" href="{% url 'accounts:profile' comment.author.profile.pk %}">@{{ comment.author }}</a>
              </strong>
              <small>
                <time class="time">
                  <a class="has-text-warning">&nbsp{{ comment.timestamp }}</a>
                </time>
              </small>
              <br>
              {{ comment.comment }}
            </p>
          </div>
          <nav class="level is-mobile">
            <div class="level-left">
              <a class="level-item has-text-warning has-tooltip-bottom has-tooltip-arrow has-tooltip-warning" data-tooltip="Reply">
                <span class="material-icons" onclick="commentReplyToggle('{{ comment.pk }}')">reply</span>
              </a>
              <form class="level-item" method="POST" action="{% url 'posts:comment-like' post.pk comment.pk%}">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.path }}">
                <button style="background-color: transparent; border: none; box-shadow: none;" type="submit">
                  {% if user in comment.likes.all %}
                  <a class="level-item has-text-warning">
                    <span class="material-icons">favorite</span>
                  </a>
                  {% else %}
                  <a class="level-item has-text-warning">
                    <span class="material-icons">favorite_border</span>
                  </a>
                  {% endif %}
                </button>
                <span class="level-item">{{ comment.likes.all.count }}</span>
              </form>
            </nav>
            <div class="mt-3 mb-5 is-hidden" id="{{ comment.pk }}">
              <div class="col">
                <form method="POST" action="{% url 'posts:comment-reply' post.pk comment.pk %}">
                  {% csrf_token %}
                  {{ form | bulma }}
                  <div class="d-grid gap-2">
                    <button class="button mt-3">Reply!</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="media-right">
            {% if request.user == comment.author %}
            <a href="{% url 'posts:comment-delete' post.pk comment.pk %}" title='delete' class="delete"></a>
            {% endif %}
          </div>
      </article>

      <!-- Comment replies -->
      <div class="pl-5 mb-5">
        {% for child_comment in comment.children %}
        <article class="media">
          <figure class="media-left">
            <a href="{% url 'accounts:profile' child_comment.author.profile.pk %}">
              <img class="image" height="40" width="40" src="{{ child_comment.author.profile.picture.url }}" />
            </a>
          </figure>
          <div class="media-content">
            <div class="content">
              <p>
                <strong>
                  <a class="has-text-warning" href="{% url 'accounts:profile' child_comment.author.profile.pk %}">@{{ child_comment.author }}</a>
                </strong>
                <small>
                  <time class="time">
                    <a class="has-text-warning">&nbsp{{ child_comment.timestamp }}</a>
                  </time>
                </small>
                <br>
                {{ child_comment.comment }}
              </p>
            </div>
            <nav class="level is-mobile">
              <div class="level-left">
                <form class="level-item" method="POST" action="{% url 'posts:comment-like' post.pk child_comment.pk%}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.path }}">
                  <button style="background-color: transparent; border: none; box-shadow: none;" type="submit">
                    {% if user in child_comment.likes.all %}
                    <a class="level-item has-text-warning">
                      <span class="material-icons">favorite</span>
                    </a>
                    {% else %}
                    <a class="level-item has-text-warning">
                      <span class="material-icons">favorite_border</span>
                    </a>
                    {% endif %}
                  </button>
                  <span class="level-item">{{ child_comment.likes.all.count }}</span>
                </form>
              </nav>
            </div>
            <div class="media-right">
              {% if request.user == child_comment.author %}
              <a href="{% url 'posts:comment-delete' post.pk comment.pk %}" title='delete' class="delete"></a>
              {% endif %}
            </div>
          </article>
          {% endfor %}
      </div>

      {% endif %}
    {% endfor %}

    <!-- Comment form -->
    <form class="mt-5" method="POST">
      {% csrf_token %}
      {{ form | bulma }}
      <button class="button mt-3">Comment</button>
    </form>

  </div>

</div>
{% endblock %}
